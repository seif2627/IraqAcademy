<!DOCTYPE html>



<html lang="en">
<head>



  <meta charset="UTF-8">



  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses | Iraq Academy</title>
  <meta name="description" content="Browse Iraq Academy courses by category, teacher, and grade.">
  <link rel="icon" href="../Logo/LogoNoBackground.png" type="image/png">



  <script src="https://cdn.tailwindcss.com"></script>



  <link rel="stylesheet" href="../assets/styles.css">



</head>



<body class="bg-white text-slate-900 font-sans p-6 lg:p-8">
  <div class="max-w-7xl mx-auto">



    <div class="flex justify-between items-end mb-12 flex-wrap gap-6">



      <div>



        <h1 class="text-4xl font-bold mb-2">Available Courses</h1>
        <p class="text-slate-600 text-lg">Browse our wide range of specialized educational courses.</p>
      </div>



      <div class="flex gap-4">
        <select id="categoryFilter" class="border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-accent outline-none">
          <option value="">All Categories</option>
          <option value="Science">Science</option>
          <option value="Mathematics">Mathematics</option>
          <option value="Languages">Languages</option>
          <option value="Technology">Technology</option>
        </select>
      </div>



    </div>







    <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
      <div id="cartSummary" class="text-sm text-slate-600">Loading your cart...</div>
      <div class="flex gap-2">
        <button id="checkoutBtn" class="px-4 py-2 rounded-xl border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors">Checkout</button>
      </div>
    </div>
    <div id="cartNotice" class="text-sm text-slate-500 mb-4"></div>
    <div class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 courses-grid"></div>

    <div id="enrollmentsPanel" class="mt-12 hidden">
      <h2 class="text-2xl font-bold mb-4">My Enrollments</h2>
      <div id="enrollmentsList" class="grid md:grid-cols-2 gap-4"></div>
    </div>



  </div>







  <script src="../assets/config.js"></script>



  <script type="module" src="../assets/convex.js"></script>



  







  






  




  


  <script>
    const coursesGrid = document.querySelector('.courses-grid');
    const cartSummary = document.getElementById('cartSummary');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const cartNotice = document.getElementById('cartNotice');
    const categoryFilter = document.getElementById('categoryFilter');
    const enrollmentsPanel = document.getElementById('enrollmentsPanel');
    const enrollmentsList = document.getElementById('enrollmentsList');
    let cachedCourses = [];
    let cartCourseIds = new Set();
    let enrolledCourseIds = new Set();
    let isCheckingOut = false;
    let isLoggedIn = false;
    let currentRole = null;

    const setCartNotice = (message, tone = 'muted') => {
      if (!cartNotice) return;
      cartNotice.textContent = message || '';
      cartNotice.classList.remove('text-rose-600', 'text-emerald-600', 'text-slate-500');
      if (!message) {
        cartNotice.classList.add('text-slate-500');
        return;
      }
      if (tone === 'error') {
        cartNotice.classList.add('text-rose-600');
      } else if (tone === 'success') {
        cartNotice.classList.add('text-emerald-600');
      } else {
        cartNotice.classList.add('text-slate-500');
      }
    };

    const applyCourseButtonState = (button, courseId) => {
      if (!button) return;
      if (enrolledCourseIds.has(courseId)) {
        button.textContent = 'Enrolled';
        button.disabled = true;
        return;
      }
      if (cartCourseIds.has(courseId)) {
        button.textContent = 'In Cart';
        button.disabled = true;
        return;
      }
      button.textContent = 'Add to Cart';
      button.disabled = false;
    };

    const syncCourseButtons = () => {
      if (!coursesGrid) return;
      coursesGrid.querySelectorAll('.add-to-cart').forEach((button) => {
        const courseId = button.getAttribute('data-course-id');
        if (courseId) applyCourseButtonState(button, courseId);
      });
    };

    const updateCheckoutState = () => {
      if (!checkoutBtn) return;
      const shouldDisable = isCheckingOut || !isLoggedIn || currentRole !== 'student' || cartCourseIds.size === 0;
      checkoutBtn.disabled = shouldDisable;
      checkoutBtn.textContent = isCheckingOut ? 'Processing...' : 'Checkout';
    };

    const renderCourses = (courses) => {
      coursesGrid.innerHTML = '';
      if (!courses.length) {
        coursesGrid.innerHTML = '<div class="text-slate-500 text-sm">No courses found.</div>';
        return;
      }
      courses.forEach((course) => {
        const card = document.createElement('div');
        card.className = 'group bg-white border border-slate-100 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300';
        const badge = course.grade || 'General';
        const title = course.title || '';
        const subtitleParts = [];
        if (course.grade) subtitleParts.push(course.grade);
        if (course.teacherName) subtitleParts.push(course.teacherName);
        const subtitle = subtitleParts.join(' - ');
        const type = course.type || 'Training Course';
        const status = course.status || 'Available Now';
        const description = course.description || '';
        const duration = course.subtitle || '';
        const imageUrl = course.imageUrl || '';
        let imageHtml = '';
        if (imageUrl) {
          imageHtml = `<img src="${imageUrl}" alt="${title}" class="w-full h-full object-cover">`;
        } else {
          imageHtml = '<div class="w-full h-full flex items-center justify-center text-slate-400 bg-slate-100"><span>Course Image</span></div>';
        }

        card.innerHTML = `
          <div class="relative h-48 bg-slate-200">
            ${imageHtml}
            <div class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-accent">${badge}</div>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-bold mb-2 group-hover:text-accent transition-colors">${title}</h3>
            <p class="text-slate-600 text-sm mb-2 line-clamp-2">${subtitle}</p>
            <p class="text-slate-500 text-sm mb-3 course-desc line-clamp-2">${description}</p>
            <div class="text-xs text-slate-500 mb-4">${duration}</div>
            <div class="flex items-center justify-between pt-4 border-t border-slate-50">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-slate-700">${type}</span>
              </div>
              <div class="text-accent font-bold">${status}</div>
            </div>
            <div class="mt-4">
              <button class="add-to-cart px-4 py-2 rounded-xl border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors" data-course-id="${course._id}">Add to Cart</button>
            </div>
          </div>
        `;

        coursesGrid.appendChild(card);
        
        const addBtn = card.querySelector('.add-to-cart');
        applyCourseButtonState(addBtn, course._id);
        addBtn.addEventListener('click', async () => {
          if (!window.top?.iaStore) return;
          if (addBtn.disabled) return;
          addBtn.disabled = true;
          addBtn.textContent = 'Adding...';
          setCartNotice('');
          const item = {
            courseId: course._id,
            title: course.title || '',
            price: Number(course.price || 0)
          };
          try {
            await window.top.iaStore.addToCart(item);
            await updateCartSummary();
            applyCourseButtonState(addBtn, course._id);
            setCartNotice('Course added to cart.', 'success');
          } catch (error) {
            setCartNotice('Unable to add to cart. Please try again.', 'error');
            applyCourseButtonState(addBtn, course._id);
          }
        });
      });
    };

    async function loadCourses() {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !coursesGrid) {
        return;
      }

      coursesGrid.innerHTML = '<div class="text-slate-500 text-sm">Loading courses...</div>';
      try {
        const courses = await convex.query('content:getCourses', {});
        cachedCourses = courses;
        const filtered = categoryFilter?.value
          ? courses.filter((course) => (course.category || '') === categoryFilter.value)
          : courses;

        renderCourses(filtered);
      } catch (error) {
        coursesGrid.innerHTML = '<div class="text-slate-500 text-sm">We could not load courses. Please try again.</div>';
      }
    }

    async function loadEnrollments() {
      const convex = window.top?.convexClient || window.convexClient;
      const client = window.top?.authClient || window.authClient;
      if (!convex || !client) return;
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        isLoggedIn = false;
        currentRole = null;
        enrolledCourseIds = new Set();
        if (enrollmentsPanel) enrollmentsPanel.classList.add('hidden');
        updateCheckoutState();
        syncCourseButtons();
        return;
      }
      isLoggedIn = true;
      currentRole = session?.user?.user_metadata?.role || 'student';
      try {
        const enrollments = await convex.query('enrollments:listByUser', { userId: session.user.id });
        enrollmentsPanel.classList.remove('hidden');
        enrolledCourseIds = new Set(enrollments.map((enrollment) => String(enrollment.courseId)));
        if (!enrollments.length) {
          enrollmentsList.innerHTML = '<div class="text-slate-500 text-sm">No enrollments yet.</div>';
          syncCourseButtons();
          updateCheckoutState();
          return;
        }
        enrollmentsList.innerHTML = enrollments.map((enrollment) => {
          const course = cachedCourses.find((c) => c._id === enrollment.courseId);
          const title = course?.title || 'Course';
          const status = enrollment.status || 'active';
          return `
            <div class="border border-slate-200 rounded-2xl p-4 bg-white shadow-sm">
              <div class="font-bold text-slate-900">${title}</div>
              <div class="text-sm text-slate-500 mt-1">Status: ${status}</div>
            </div>
          `;
        }).join('');
        syncCourseButtons();
        updateCheckoutState();
      } catch (error) {
        enrollmentsPanel.classList.remove('hidden');
        enrollmentsList.innerHTML = '<div class="text-slate-500 text-sm">Unable to load enrollments.</div>';
        updateCheckoutState();
      }
    }

    async function updateCartSummary(cartOverride) {
      if (!window.top?.iaStore || !cartSummary) return;
      const cart = cartOverride || await window.top.iaStore.getCart();
      cartCourseIds = new Set(cart.items.map((item) => String(item.courseId)));
      syncCourseButtons();
      const count = cart.items.reduce((sum, i) => sum + (i.qty || 1), 0);
      const total = cart.items.reduce((sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1), 0);
      if (count === 0) {
        cartSummary.textContent = 'Your cart is empty.';
        updateCheckoutState();
        return;
      }
      cartSummary.textContent = `Cart: ${count} items - Total: ${total.toFixed(2)}`;
      updateCheckoutState();
    }

    checkoutBtn.addEventListener('click', async () => {
      if (!window.top?.iaStore) return;
      if (isCheckingOut) return;
      setCartNotice('');
      const client = window.top?.authClient || window.authClient;
      const { data: { session } } = client ? await client.auth.getSession() : { data: { session: null } };
      if (!session) {
        setCartNotice('Please log in to checkout.', 'error');
        updateCheckoutState();
        return;
      }
      if (currentRole !== 'student') {
        setCartNotice('Only students can checkout.', 'error');
        updateCheckoutState();
        return;
      }
      const cart = await window.top.iaStore.getCart();
      if (!cart.items.length) {
        setCartNotice('Your cart is empty.', 'error');
        updateCheckoutState();
        return;
      }
      const filteredItems = cart.items.filter((item) => !enrolledCourseIds.has(String(item.courseId)));
      if (!filteredItems.length) {
        setCartNotice('You are already enrolled in these courses.', 'error');
        await updateCartSummary(cart);
        syncCourseButtons();
        return;
      }
      if (filteredItems.length !== cart.items.length) {
        for (const item of cart.items) {
          if (enrolledCourseIds.has(String(item.courseId))) {
            await window.top.iaStore.removeFromCart(item.courseId);
          }
        }
        await updateCartSummary();
        setCartNotice('Removed already enrolled courses from your cart.', 'success');
      }
      isCheckingOut = true;
      updateCheckoutState();
      const payload = {
        items: filteredItems,
        total: filteredItems.reduce((sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1), 0),
        paymentMethod: 'card',
        payerName: '',
        phone: '',
        notes: 'Checkout submitted'
      };
      try {
        const result = await window.top.iaStore.checkout(payload);
        setCartNotice('Redirecting to secure checkout...', 'success');
        if (result?.checkoutUrl) {
          window.top.location.href = result.checkoutUrl;
          return;
        }
        throw new Error('Missing checkout URL');
      } catch (error) {
        setCartNotice('Checkout failed. Please try again.', 'error');
      } finally {
        isCheckingOut = false;
        updateCheckoutState();
      }
    });

    categoryFilter?.addEventListener('change', () => {
      const filtered = categoryFilter.value
        ? cachedCourses.filter((course) => (course.category || '') === categoryFilter.value)
        : cachedCourses;
      renderCourses(filtered);
    });

    const clearCheckoutParams = () => {
      if (window.top?.history?.replaceState) {
        window.top.history.replaceState(null, '', '/courses');
      }
    };

    const pollOrderStatus = async (sessionId, attempts = 0) => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex) return;
      try {
        const order = await convex.query('orders:getByStripeSessionId', { sessionId });
        if (order.paymentStatus === 'paid') {
          setCartNotice('Payment confirmed. You are enrolled!', 'success');
          await updateCartSummary();
          await loadEnrollments();
          clearCheckoutParams();
          return;
        }
        if (order.paymentStatus === 'failed') {
          setCartNotice('Payment failed. Please try again.', 'error');
          clearCheckoutParams();
          return;
        }
        if (order.paymentStatus === 'expired') {
          setCartNotice('Payment expired. Please try again.', 'error');
          clearCheckoutParams();
          return;
        }
        if (attempts < 5) {
          setTimeout(() => pollOrderStatus(sessionId, attempts + 1), 2000);
        } else {
          setCartNotice('Payment is still processing. Please refresh in a moment.', 'error');
        }
      } catch (error) {
        setCartNotice('Unable to verify payment status. Please refresh later.', 'error');
      }
    };

    const handleCheckoutReturn = async () => {
      const params = new URLSearchParams(window.location.search);
      const status = params.get('checkout');
      const sessionId = params.get('session_id');
      if (!status) return;
      if (status === 'cancel') {
        setCartNotice('Payment canceled. You can try again.', 'error');
        clearCheckoutParams();
        return;
      }
      if (status === 'success') {
        const client = window.top?.authClient || window.authClient;
        const { data: { session } } = client ? await client.auth.getSession() : { data: { session: null } };
        if (!session) {
          setCartNotice('Log in to confirm your payment.', 'error');
          return;
        }
        if (!sessionId) {
          setCartNotice('Missing checkout session. Please contact support.', 'error');
          return;
        }
        setCartNotice('Confirming payment...', 'success');
        pollOrderStatus(sessionId, 0);
      }
    };

    loadCourses();
    updateCartSummary();
    loadEnrollments();
    handleCheckoutReturn();
  </script>
</body>
</html>
