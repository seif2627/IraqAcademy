<!DOCTYPE html>



<html lang="en">
<head>



  <meta charset="UTF-8">



  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses | Iraq Academy</title>
  <meta name="description" content="Browse Iraq Academy courses by category, teacher, and grade.">
  <link rel="icon" href="../Logo/LogoNoBackground.png" type="image/png">



  <script src="https://cdn.tailwindcss.com"></script>



  <link rel="stylesheet" href="../assets/styles.css">



</head>



<body class="bg-white text-slate-900 font-sans p-6 lg:p-8">
  <div class="max-w-7xl mx-auto">



    <div class="flex justify-between items-end mb-12 flex-wrap gap-6">



      <div>



        <h1 class="text-4xl font-bold mb-2">Available Courses</h1>
        <p class="text-slate-600 text-lg">Browse our wide range of specialized educational courses.</p>
      </div>



      <div class="flex gap-4">
        <select id="categoryFilter" class="border-2 border-slate-200 rounded-lg px-4 py-2 focus:border-accent outline-none">
          <option value="">All Categories</option>
        </select>
      </div>



    </div>







    <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
      <div id="cartSummary" class="text-sm text-slate-600">Loading your cart...</div>
      <div class="flex gap-2">
        <button id="checkoutBtn" class="px-4 py-2 rounded-xl border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors">Checkout</button>
      </div>
    </div>
    <div id="cartNotice" class="text-sm text-slate-500 mb-4"></div>
    <div class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 courses-grid"></div>

    <div id="enrollmentsPanel" class="mt-12 hidden">
      <h2 class="text-2xl font-bold mb-4">My Enrollments</h2>
      <div id="enrollmentsList" class="grid md:grid-cols-2 gap-4"></div>
    </div>



  </div>







  <script src="../assets/config.js"></script>



  <script type="module" src="../assets/convex.js"></script>



  







  






  




  


  <script>
    const coursesGrid = document.querySelector('.courses-grid');
    const cartSummary = document.getElementById('cartSummary');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const cartNotice = document.getElementById('cartNotice');
    const categoryFilter = document.getElementById('categoryFilter');
    const enrollmentsPanel = document.getElementById('enrollmentsPanel');
    const enrollmentsList = document.getElementById('enrollmentsList');
    let cachedCourses = [];
    let activeSearchTerm = '';
    let cartCourseIds = new Set();
    let enrolledCourseIds = new Set();
    let isCheckingOut = false;
    let isLoggedIn = false;
    let currentRole = null;

    const waitForConvex = (timeoutMs = 5000) => new Promise((resolve, reject) => {
      const start = Date.now();
      const timer = setInterval(() => {
        const client = window.top?.convexClient || window.convexClient;
        if (client) {
          clearInterval(timer);
          resolve(client);
          return;
        }
        if (Date.now() - start >= timeoutMs) {
          clearInterval(timer);
          reject(new Error('Convex client not ready'));
        }
      }, 50);
    });

    const waitForAuthReady = (timeoutMs = 5000) => {
      const authReady = window.top?.iaAuthReady || window.iaAuthReady;
      if (!authReady || typeof authReady.then !== 'function') {
        return Promise.resolve();
      }
      return new Promise((resolve) => {
        let settled = false;
        const timer = setTimeout(() => {
          if (settled) return;
          settled = true;
          resolve();
        }, timeoutMs);
        authReady.then(() => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          resolve();
        }).catch(() => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          resolve();
        });
      });
    };

    const getConvexClient = async () => {
      const existing = window.top?.convexClient || window.convexClient;
      if (existing) {
        await waitForAuthReady();
        return existing;
      }
      try {
        const client = await waitForConvex();
        await waitForAuthReady();
        return client;
      } catch (error) {
        return null;
      }
    };

    const getSearchTerm = () => {
      const params = new URLSearchParams(window.location.search);
      return (params.get('search') || '').trim();
    };

    const withTimeout = async (promise, timeoutMs = 8000) => {
      let timeoutId;
      const timeoutPromise = new Promise((_, reject) => {
        timeoutId = setTimeout(() => reject(new Error('Request timed out')), timeoutMs);
      });
      try {
        return await Promise.race([promise, timeoutPromise]);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    const syncCategoryFilter = (courses) => {
      if (!categoryFilter) return;
      const previous = categoryFilter.value;
      const categories = Array.from(new Set(
        (courses || [])
          .map((course) => String(course.category || '').trim())
          .filter(Boolean)
      )).sort((a, b) => a.localeCompare(b));
      categoryFilter.innerHTML = '';
      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = 'All Categories';
      categoryFilter.appendChild(allOption);
      categories.forEach((category) => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
      if (previous && categories.includes(previous)) {
        categoryFilter.value = previous;
      } else {
        categoryFilter.value = '';
      }
    };

    const setCartNotice = (message, tone = 'muted') => {
      if (!cartNotice) return;
      cartNotice.textContent = message || '';
      cartNotice.classList.remove('text-rose-600', 'text-emerald-600', 'text-slate-500');
      if (!message) {
        cartNotice.classList.add('text-slate-500');
        return;
      }
      if (tone === 'error') {
        cartNotice.classList.add('text-rose-600');
      } else if (tone === 'success') {
        cartNotice.classList.add('text-emerald-600');
      } else {
        cartNotice.classList.add('text-slate-500');
      }
    };

    const applyCourseButtonState = (button, courseId) => {
      if (!button) return;
      if (enrolledCourseIds.has(courseId)) {
        button.textContent = 'Enrolled';
        button.disabled = true;
        return;
      }
      if (cartCourseIds.has(courseId)) {
        button.textContent = 'In Cart';
        button.disabled = true;
        return;
      }
      button.textContent = 'Add to Cart';
      button.disabled = false;
    };

    const syncCourseButtons = () => {
      if (!coursesGrid) return;
      coursesGrid.querySelectorAll('.add-to-cart').forEach((button) => {
        const courseId = button.getAttribute('data-course-id');
        if (courseId) applyCourseButtonState(button, courseId);
      });
    };

    const updateCheckoutState = () => {
      if (!checkoutBtn) return;
      const shouldDisable = isCheckingOut || !isLoggedIn || currentRole !== 'student' || cartCourseIds.size === 0;
      checkoutBtn.disabled = shouldDisable;
      checkoutBtn.textContent = isCheckingOut ? 'Processing...' : 'Checkout';
    };

    const renderCourses = (courses) => {
      coursesGrid.innerHTML = '';
      if (!courses.length) {
        const empty = document.createElement('div');
        empty.className = 'text-slate-500 text-sm';
        empty.textContent = activeSearchTerm
          ? `No courses match "${activeSearchTerm}".`
          : 'No courses available yet.';
        coursesGrid.appendChild(empty);
        return;
      }
      courses.forEach((course) => {
        const card = document.createElement('div');
        card.className = 'group bg-white border border-slate-100 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300';
        const badge = course.grade || 'General';
        const title = course.title || 'Course';
        const subtitleParts = [];
        if (course.grade) subtitleParts.push(course.grade);
        if (course.teacherName) subtitleParts.push(course.teacherName);
        const subtitle = subtitleParts.join(' - ');
        const type = course.type || 'Training Course';
        const status = course.status || 'Available Now';
        const description = course.description || '';
        const duration = course.subtitle || '';
        const imageUrl = course.imageUrl || '';

        const media = document.createElement('div');
        media.className = 'relative h-48 bg-slate-200';

        const badgeEl = document.createElement('div');
        badgeEl.className = 'absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-accent';
        badgeEl.textContent = badge;

        if (imageUrl) {
          const img = document.createElement('img');
          img.src = imageUrl;
          img.alt = title;
          img.className = 'w-full h-full object-cover';
          img.addEventListener('error', () => {
            const fallback = document.createElement('div');
            fallback.className = 'w-full h-full flex items-center justify-center text-slate-400 bg-slate-100';
            const span = document.createElement('span');
            span.textContent = 'Image coming soon';
            fallback.appendChild(span);
            media.replaceChildren(fallback, badgeEl);
          });
          media.appendChild(img);
        } else {
          const fallback = document.createElement('div');
          fallback.className = 'w-full h-full flex items-center justify-center text-slate-400 bg-slate-100';
          const span = document.createElement('span');
          span.textContent = 'Image coming soon';
          fallback.appendChild(span);
          media.appendChild(fallback);
        }
        media.appendChild(badgeEl);

        const body = document.createElement('div');
        body.className = 'p-6';
        const titleEl = document.createElement('h3');
        titleEl.className = 'text-xl font-bold mb-2 group-hover:text-accent transition-colors';
        titleEl.textContent = title;
        const subtitleEl = document.createElement('p');
        subtitleEl.className = 'text-slate-600 text-sm mb-2 line-clamp-2';
        subtitleEl.textContent = subtitle;
        const descEl = document.createElement('p');
        descEl.className = 'text-slate-500 text-sm mb-3 course-desc line-clamp-2';
        descEl.textContent = description;
        const durationEl = document.createElement('div');
        durationEl.className = 'text-xs text-slate-500 mb-4';
        durationEl.textContent = duration;
        const footer = document.createElement('div');
        footer.className = 'flex items-center justify-between pt-4 border-t border-slate-50';
        const typeEl = document.createElement('span');
        typeEl.className = 'text-sm font-medium text-slate-700';
        typeEl.textContent = type;
        const statusEl = document.createElement('div');
        statusEl.className = 'text-accent font-bold';
        statusEl.textContent = status;
        const typeWrap = document.createElement('div');
        typeWrap.className = 'flex items-center gap-2';
        typeWrap.appendChild(typeEl);
        footer.appendChild(typeWrap);
        footer.appendChild(statusEl);

        const actionWrap = document.createElement('div');
        actionWrap.className = 'mt-4';
        const addBtn = document.createElement('button');
        addBtn.className = 'add-to-cart px-4 py-2 rounded-xl border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors';
        addBtn.setAttribute('data-course-id', course._id);
        addBtn.textContent = 'Add to Cart';
        actionWrap.appendChild(addBtn);

        body.appendChild(titleEl);
        body.appendChild(subtitleEl);
        body.appendChild(descEl);
        body.appendChild(durationEl);
        body.appendChild(footer);
        body.appendChild(actionWrap);

        card.appendChild(media);
        card.appendChild(body);
        coursesGrid.appendChild(card);

        applyCourseButtonState(addBtn, course._id);
        addBtn.addEventListener('click', async () => {
          if (!window.top?.iaStore) return;
          if (addBtn.disabled) return;
          setCartNotice('');
          const client = window.top?.authClient || window.authClient;
          const { data: { session } } = client ? await client.auth.getSession() : { data: { session: null } };
          if (!session) {
            isLoggedIn = false;
            currentRole = null;
            updateCheckoutState();
            setCartNotice('Please log in to add courses to your cart.', 'error');
            return;
          }
          const role = session?.user?.user_metadata?.role || 'student';
          isLoggedIn = true;
          currentRole = role;
          updateCheckoutState();
          if (role !== 'student') {
            setCartNotice('Only students can add courses to the cart.', 'error');
            return;
          }
          addBtn.disabled = true;
          addBtn.textContent = 'Adding...';
          const item = {
            courseId: course._id,
            title: course.title || '',
            price: Number(course.price || 0)
          };
          try {
            await window.top.iaStore.addToCart(item);
            await updateCartSummary();
            applyCourseButtonState(addBtn, course._id);
            setCartNotice('Course added to cart.', 'success');
          } catch (error) {
            setCartNotice('Unable to add to cart. Please try again.', 'error');
            applyCourseButtonState(addBtn, course._id);
          }
        });
      });
    };

    async function loadCourses() {
      if (!coursesGrid) return;
      coursesGrid.innerHTML = '<div class="text-slate-500 text-sm">Loading courses...</div>';
      const convex = await getConvexClient();
      if (!convex) {
        coursesGrid.innerHTML = '<div class="text-slate-500 text-sm">We are having trouble loading courses right now. Please try again.</div>';
        return;
      }

      const searchTerm = getSearchTerm();
      activeSearchTerm = searchTerm;
      try {
        let courses = await withTimeout(convex.query('content:getCoursesPublic', {
          limit: 200,
          search: searchTerm || undefined
        }));
        if (!Array.isArray(courses)) courses = [];
        cachedCourses = courses;
        syncCategoryFilter(courses);
        const filtered = categoryFilter?.value
          ? courses.filter((course) => (course.category || '') === categoryFilter.value)
          : courses;
        renderCourses(filtered);
      } catch (error) {
        try {
          const fallback = await withTimeout(convex.query('content:getCourses', {}));
          let courses = Array.isArray(fallback) ? fallback : [];
          if (searchTerm) {
            const term = searchTerm.toLowerCase();
            courses = courses.filter((course) => String(course.title || '').toLowerCase().includes(term));
          }
          cachedCourses = courses;
          syncCategoryFilter(courses);
          renderCourses(courses);
        } catch (fallbackError) {
          coursesGrid.innerHTML = '<div class="text-slate-500 text-sm">We are having trouble loading courses. Please try again shortly.</div>';
        }
      }
    }

    async function loadEnrollments() {
      const convex = await getConvexClient();
      const client = window.top?.authClient || window.authClient;
      if (!convex || !client) return;
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        isLoggedIn = false;
        currentRole = null;
        enrolledCourseIds = new Set();
        if (enrollmentsPanel) enrollmentsPanel.classList.add('hidden');
        updateCheckoutState();
        syncCourseButtons();
        return;
      }
      isLoggedIn = true;
      currentRole = session?.user?.user_metadata?.role || 'student';
      try {
        const enrollments = await convex.query('enrollments:listByUser', { userId: session.user.id });
        enrollmentsPanel.classList.remove('hidden');
        enrolledCourseIds = new Set(enrollments.map((enrollment) => String(enrollment.courseId)));
        if (!enrollments.length) {
          enrollmentsList.innerHTML = '<div class="text-slate-500 text-sm">No enrollments yet.</div>';
          syncCourseButtons();
          updateCheckoutState();
          return;
        }
        enrollmentsList.innerHTML = '';
        enrollments.forEach((enrollment) => {
          const course = cachedCourses.find((c) => c._id === enrollment.courseId);
          const title = course?.title || 'Course';
          const status = enrollment.status || 'active';
          const card = document.createElement('div');
          card.className = 'border border-slate-200 rounded-2xl p-4 bg-white shadow-sm';
          const titleEl = document.createElement('div');
          titleEl.className = 'font-bold text-slate-900';
          titleEl.textContent = title;
          const statusEl = document.createElement('div');
          statusEl.className = 'text-sm text-slate-500 mt-1';
          statusEl.textContent = `Status: ${status}`;
          card.appendChild(titleEl);
          card.appendChild(statusEl);
          enrollmentsList.appendChild(card);
        });
        syncCourseButtons();
        updateCheckoutState();
      } catch (error) {
        enrollmentsPanel.classList.remove('hidden');
        enrollmentsList.innerHTML = '<div class="text-slate-500 text-sm">Unable to load enrollments.</div>';
        updateCheckoutState();
      }
    }

    async function updateCartSummary(cartOverride) {
      if (!window.top?.iaStore || !cartSummary) return;
      const cart = cartOverride || await window.top.iaStore.getCart();
      cartCourseIds = new Set(cart.items.map((item) => String(item.courseId)));
      syncCourseButtons();
      const count = cart.items.reduce((sum, i) => sum + (i.qty || 1), 0);
      const total = cart.items.reduce((sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1), 0);
      if (count === 0) {
        cartSummary.textContent = 'Your cart is empty.';
        updateCheckoutState();
        return;
      }
      cartSummary.textContent = `Cart: ${count} items - Total: ${total.toFixed(2)}`;
      updateCheckoutState();
    }

    checkoutBtn.addEventListener('click', async () => {
      if (!window.top?.iaStore) return;
      if (isCheckingOut) return;
      setCartNotice('');
      const client = window.top?.authClient || window.authClient;
      const { data: { session } } = client ? await client.auth.getSession() : { data: { session: null } };
      if (!session) {
        setCartNotice('Please log in to checkout.', 'error');
        updateCheckoutState();
        return;
      }
      if (currentRole !== 'student') {
        setCartNotice('Only students can checkout.', 'error');
        updateCheckoutState();
        return;
      }
      const cart = await window.top.iaStore.getCart();
      if (!cart.items.length) {
        setCartNotice('Your cart is empty.', 'error');
        updateCheckoutState();
        return;
      }
      const filteredItems = cart.items.filter((item) => !enrolledCourseIds.has(String(item.courseId)));
      if (!filteredItems.length) {
        setCartNotice('You are already enrolled in these courses.', 'error');
        await updateCartSummary(cart);
        syncCourseButtons();
        return;
      }
      if (filteredItems.length !== cart.items.length) {
        for (const item of cart.items) {
          if (enrolledCourseIds.has(String(item.courseId))) {
            await window.top.iaStore.removeFromCart(item.courseId);
          }
        }
        await updateCartSummary();
        setCartNotice('Removed already enrolled courses from your cart.', 'success');
      }
      isCheckingOut = true;
      updateCheckoutState();
      const payload = {
        items: filteredItems,
        total: filteredItems.reduce((sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1), 0),
        paymentMethod: 'card',
        payerName: '',
        phone: '',
        notes: 'Checkout submitted'
      };
      try {
        const result = await window.top.iaStore.checkout(payload);
        setCartNotice('Redirecting to secure checkout...', 'success');
        if (result?.checkoutUrl) {
          window.top.location.href = result.checkoutUrl;
          return;
        }
        throw new Error('Missing checkout URL');
      } catch (error) {
        setCartNotice('Checkout failed. Please try again.', 'error');
      } finally {
        isCheckingOut = false;
        updateCheckoutState();
      }
    });

    categoryFilter?.addEventListener('change', () => {
      const filtered = categoryFilter.value
        ? cachedCourses.filter((course) => (course.category || '') === categoryFilter.value)
        : cachedCourses;
      renderCourses(filtered);
    });

    const clearCheckoutParams = () => {
      if (window.top?.history?.replaceState) {
        window.top.history.replaceState(null, '', '/courses');
      }
    };

    const pollOrderStatus = async (sessionId, attempts = 0) => {
      const convex = await getConvexClient();
      if (!convex) return;
      try {
        const order = await convex.query('orders:getByStripeSessionId', { sessionId });
        if (order.paymentStatus === 'paid') {
          setCartNotice('Payment confirmed. You are enrolled!', 'success');
          await updateCartSummary();
          await loadEnrollments();
          clearCheckoutParams();
          return;
        }
        if (order.paymentStatus === 'failed') {
          setCartNotice('Payment failed. Please try again.', 'error');
          clearCheckoutParams();
          return;
        }
        if (order.paymentStatus === 'expired') {
          setCartNotice('Payment expired. Please try again.', 'error');
          clearCheckoutParams();
          return;
        }
        if (attempts < 5) {
          setTimeout(() => pollOrderStatus(sessionId, attempts + 1), 2000);
        } else {
          setCartNotice('Payment is still processing. Please check again shortly.', 'error');
        }
      } catch (error) {
        setCartNotice('Unable to verify payment status. Please refresh later.', 'error');
      }
    };

    const handleCheckoutReturn = async () => {
      const params = new URLSearchParams(window.location.search);
      const status = params.get('checkout');
      const sessionId = params.get('session_id');
      if (!status) return;
      if (status === 'cancel') {
        setCartNotice('Payment canceled. You can try again.', 'error');
        clearCheckoutParams();
        return;
      }
      if (status === 'success') {
        const client = window.top?.authClient || window.authClient;
        const { data: { session } } = client ? await client.auth.getSession() : { data: { session: null } };
        if (!session) {
          setCartNotice('Log in to confirm your payment.', 'error');
          return;
        }
        if (!sessionId) {
          setCartNotice('Missing checkout session. Please contact support.', 'error');
          return;
        }
        setCartNotice('Confirming payment...', 'success');
        pollOrderStatus(sessionId, 0);
      }
    };

    (async () => {
      await loadCourses();
      await updateCartSummary();
      await loadEnrollments();
      handleCheckoutReturn();
    })();
  </script>
</body>
</html>
