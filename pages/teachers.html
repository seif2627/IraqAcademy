<!DOCTYPE html>



<html lang="ar" dir="rtl">
<head>



  <meta charset="UTF-8">



  <meta name="viewport" content="width=device-width, initial-scale=1.0">



  <script src="https://cdn.tailwindcss.com"></script>



  <link rel="stylesheet" href="../assets/styles.css">



</head>



<body class="bg-slate-50 text-slate-800">



  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-16">
      <h1 class="text-4xl font-extrabold text-slate-900 mb-4">كادرنا التدريسي</h1>
      <p class="text-xl text-slate-600 max-w-3xl mx-auto">مجموعة نخبوية من المدرسين لتقديم أفضل تجربة تعليمية.</p>
    </div>

    <section id="teacherManagement" class="hidden bg-white border border-slate-200 rounded-2xl p-6 shadow-sm mb-12">
      <div class="flex items-start justify-between flex-wrap gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-bold mb-2">لوحة إدارة المدرسين والدورات</h2>
          <p class="text-slate-600">إدارة ملف المدرس ودوراته حسب الصلاحيات.</p>
        </div>
        <div id="teacherManageRole" class="text-sm text-emerald-700 bg-emerald-50 px-3 py-2 rounded-xl"></div>
      </div>
      <div class="grid lg:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div id="teacherSelectWrap" class="hidden">
            <label class="block text-sm font-medium text-slate-700 mb-1">اختيار مدرس</label>
            <select id="teacherSelect" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none"></select>
          </div>
          <div class="flex items-center gap-4">
            <img id="teacherImagePreview" src="" alt="Teacher" class="w-20 h-20 rounded-full border border-slate-200 object-cover hidden">
            <div>
              <input id="teacherImageInput" type="file" accept="image/*" class="block text-sm text-slate-600">
              <div class="text-xs text-slate-500 mt-1">سيتم قص الصورة تلقائياً.</div>
            </div>
          </div>
          <input id="teacherNameInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="اسم المدرس">
          <input id="teacherSubjectInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="المادة">
          <textarea id="teacherBioInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" rows="4" placeholder="نبذة مختصرة"></textarea>
          <input id="teacherGenderInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="الجنس">
          <div class="flex gap-3">
            <button id="saveTeacherBtn" class="flex-1 bg-accent text-white rounded-xl py-3 font-bold shadow-lg hover:bg-emerald-600 transition-all">حفظ المدرس</button>
            <button id="createTeacherBtn" class="flex-1 border border-slate-200 rounded-xl py-3 font-bold text-slate-700 hover:border-accent hover:text-accent transition-all hidden">إنشاء ملف</button>
          </div>
          <button id="deleteTeacherBtn" class="w-full border border-rose-200 text-rose-600 rounded-xl py-3 font-bold hover:bg-rose-50 transition-all hidden">حذف المدرس</button>
          <div id="teacherNotice" class="text-sm text-slate-600"></div>
        </div>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold">إدارة الدورات</h3>
            <button id="newCourseBtn" class="px-4 py-2 rounded-xl border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors">إضافة دورة</button>
          </div>
          <div class="grid gap-3" id="coursesList"></div>
          <div class="border border-slate-200 rounded-2xl p-4 space-y-3">
            <input id="courseTitle" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="عنوان الدورة">
            <input id="courseSubtitle" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="ملخص قصير">
            <textarea id="courseDescription" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" rows="3" placeholder="وصف الدورة"></textarea>
            <div class="grid md:grid-cols-2 gap-3">
              <input id="courseCategory" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="التصنيف">
              <input id="courseType" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="النوع">
              <input id="courseStatus" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="الحالة">
              <input id="courseGrade" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="المرحلة">
              <input id="coursePrice" type="number" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="السعر">
              <input id="courseImageUrl" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="رابط صورة الدورة">
            </div>
            <div class="flex gap-3">
              <button id="saveCourseBtn" class="flex-1 bg-accent text-white rounded-xl py-3 font-bold shadow-lg hover:bg-emerald-600 transition-all">حفظ الدورة</button>
              <button id="deleteCourseBtn" class="flex-1 border border-rose-200 text-rose-600 rounded-xl py-3 font-bold hover:bg-rose-50 transition-all hidden">حذف الدورة</button>
            </div>
            <div id="courseNotice" class="text-sm text-slate-600"></div>
          </div>
        </div>
      </div>
    </section>






    <div id="teachers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="display: none;"></div>



    



    <div id="loading" class="text-center py-12">



      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-slate-200 border-t-accent"></div>



      <p class="mt-4 text-slate-500">جارٍ تحميل بيانات المدرسين...</p>
    </div>



  </main>







  <script src="../assets/config.js"></script>
  <script type="module" src="../assets/firebase.js"></script>



  <script type="module" src="../assets/convex.js"></script>
  <script src="../assets/auth.js"></script>



  <script>



    const grid = document.getElementById('teachers-grid');



    const loading = document.getElementById('loading');
    const management = document.getElementById('teacherManagement');
    const manageRole = document.getElementById('teacherManageRole');
    const teacherSelectWrap = document.getElementById('teacherSelectWrap');
    const teacherSelect = document.getElementById('teacherSelect');
    const teacherImageInput = document.getElementById('teacherImageInput');
    const teacherImagePreview = document.getElementById('teacherImagePreview');
    const teacherNameInput = document.getElementById('teacherNameInput');
    const teacherSubjectInput = document.getElementById('teacherSubjectInput');
    const teacherBioInput = document.getElementById('teacherBioInput');
    const teacherGenderInput = document.getElementById('teacherGenderInput');
    const saveTeacherBtn = document.getElementById('saveTeacherBtn');
    const createTeacherBtn = document.getElementById('createTeacherBtn');
    const deleteTeacherBtn = document.getElementById('deleteTeacherBtn');
    const teacherNotice = document.getElementById('teacherNotice');
    const coursesList = document.getElementById('coursesList');
    const newCourseBtn = document.getElementById('newCourseBtn');
    const courseTitle = document.getElementById('courseTitle');
    const courseSubtitle = document.getElementById('courseSubtitle');
    const courseDescription = document.getElementById('courseDescription');
    const courseCategory = document.getElementById('courseCategory');
    const courseType = document.getElementById('courseType');
    const courseStatus = document.getElementById('courseStatus');
    const courseGrade = document.getElementById('courseGrade');
    const coursePrice = document.getElementById('coursePrice');
    const courseImageUrl = document.getElementById('courseImageUrl');
    const saveCourseBtn = document.getElementById('saveCourseBtn');
    const deleteCourseBtn = document.getElementById('deleteCourseBtn');
    const courseNotice = document.getElementById('courseNotice');

    let currentTeacher = null;
    let currentTeacherImage = '';
    let currentCourseId = null;
    let currentRole = 'student';







    const cropImage = (file) => new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const size = 320;
          const canvas = document.createElement('canvas');
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          const min = Math.min(img.width, img.height);
          const sx = (img.width - min) / 2;
          const sy = (img.height - min) / 2;
          ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
          resolve(canvas.toDataURL('image/jpeg', 0.85));
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    const fillTeacherForm = (teacher) => {
      currentTeacher = teacher;
      teacherNameInput.value = teacher?.name || '';
      teacherSubjectInput.value = teacher?.subject || '';
      teacherBioInput.value = teacher?.bio || '';
      teacherGenderInput.value = teacher?.gender || '';
      currentTeacherImage = teacher?.imageUrl || '';
      if (currentTeacherImage) {
        teacherImagePreview.src = currentTeacherImage;
        teacherImagePreview.classList.remove('hidden');
      } else {
        teacherImagePreview.classList.add('hidden');
      }
      deleteTeacherBtn.classList.toggle('hidden', !teacher || !(currentRole === 'admin' || currentRole === 'owner'));
    };

    const fillCourseForm = (course) => {
      currentCourseId = course?._id || null;
      courseTitle.value = course?.title || '';
      courseSubtitle.value = course?.subtitle || '';
      courseDescription.value = course?.description || '';
      courseCategory.value = course?.category || '';
      courseType.value = course?.type || '';
      courseStatus.value = course?.status || '';
      courseGrade.value = course?.grade || '';
      coursePrice.value = course?.price || '';
      courseImageUrl.value = course?.imageUrl || '';
      deleteCourseBtn.classList.toggle('hidden', !course);
    };

    const renderCourses = (courses) => {
      coursesList.innerHTML = '';
      if (!courses.length) {
        coursesList.innerHTML = '<div class="text-sm text-slate-500">لا توجد دورات بعد.</div>';
        return;
      }
      courses.forEach((course) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'border border-slate-100 rounded-xl p-3 flex items-center justify-between gap-3 flex-wrap';
        wrapper.innerHTML = `
          <div>
            <div class="font-bold text-slate-900">${course.title}</div>
            <div class="text-xs text-slate-500">${course.status || 'متاحة'}</div>
          </div>
          <button class="edit-course-btn px-3 py-1 rounded-lg border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors" data-course-id="${course._id}">تحرير</button>
        `;
        coursesList.appendChild(wrapper);
      });
    };

    const loadCourses = async (teacherId) => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !teacherId) return;
      try {
        const courses = await convex.query('content:getCoursesPublic', { teacherId });
        renderCourses(courses);
      } catch (error) {
        coursesList.innerHTML = '<div class="text-sm text-slate-500">تعذر تحميل الدورات.</div>';
      }
    };

    async function loadTeachers() {



      const convex = window.top?.convexClient || window.convexClient;
      const client = window.top?.authClient || window.authClient;



      if (!convex) {



        const message = loading.querySelector('p');



        if (message) {



          message.textContent = 'تعذر تحميل بيانات المدرسين.';
        }



        return;



      }







      try {
        if (client) {
          const { data: { session } } = await client.auth.getSession();
          currentRole = session?.user?.user_metadata?.role || 'student';
          if (session && (currentRole === 'teacher' || currentRole === 'admin' || currentRole === 'owner')) {
            management.classList.remove('hidden');
            manageRole.textContent = currentRole === 'teacher' ? 'صلاحيات مدرس' : 'صلاحيات إدارية';
          }
        }






        grid.innerHTML = '';







        teachers.forEach((teacher) => {



          const wrapper = document.createElement('div');



          wrapper.className = 'teacher-card bg-white border border-slate-100 rounded-2xl p-6 text-center shadow-sm hover:shadow-xl transition-all duration-300';



          const imageUrl = teacher.imageUrl || '../assets/images/teachers/placeholder.jpg';



          const bio = teacher.bio || '';



          wrapper.innerHTML = `



            <div class="relative w-32 h-32 mx-auto mb-6">



              <img src="${imageUrl}" alt="${teacher.name}" class="w-full h-full rounded-full object-cover border-4 border-slate-50">



              <div class="absolute bottom-0 right-0 w-8 h-8 bg-accent rounded-full flex items-center justify-center text-white border-4 border-white">



                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>



              </div>



            </div>



            <h3 class="text-xl font-bold mb-1">${teacher.name}</h3>



            <p class="text-accent font-medium text-sm mb-4">${teacher.subject}</p>



            <p class="text-slate-500 text-sm mb-6 teacher-bio line-clamp-2">${bio}</p>



            <button class="w-full py-2.5 rounded-xl border border-slate-200 text-slate-600 font-medium hover:border-accent hover:text-accent transition-colors">
              عرض الملف
            </button>
          `;



          grid.appendChild(wrapper);



        });







        grid.style.display = 'grid';

        if (management && !management.classList.contains('hidden')) {
          if (currentRole === 'teacher') {
            teacherSelectWrap.classList.add('hidden');
            const own = await convex.query('teachers:getOwn', {});
            if (!own) {
              fillTeacherForm(null);
              createTeacherBtn.classList.remove('hidden');
              saveTeacherBtn.classList.add('hidden');
              deleteTeacherBtn.classList.add('hidden');
            } else {
              fillTeacherForm(own);
              createTeacherBtn.classList.add('hidden');
              saveTeacherBtn.classList.remove('hidden');
              loadCourses(own._id);
            }
          } else if (currentRole === 'admin' || currentRole === 'owner') {
            teacherSelectWrap.classList.remove('hidden');
            teacherSelect.innerHTML = teachers.map((teacher) => `<option value="${teacher._id}">${teacher.name}</option>`).join('');
            const selected = teachers[0] || null;
            if (selected) {
              teacherSelect.value = selected._id;
              fillTeacherForm(selected);
              loadCourses(selected._id);
              createTeacherBtn.classList.add('hidden');
              saveTeacherBtn.classList.remove('hidden');
            }
          }
        }





        const message = loading.querySelector('p');



        if (message) {



          message.textContent = 'فشل تحميل بيانات المدرسين.';
        }



      }



    }







    teacherImageInput.addEventListener('change', async (event) => {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      currentTeacherImage = await cropImage(file);
      teacherImagePreview.src = currentTeacherImage;
      teacherImagePreview.classList.remove('hidden');
    });

    teacherSelect.addEventListener('change', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      const teacherId = teacherSelect.value;
      if (!convex || !teacherId) return;
      const teacher = await convex.query('content:getTeachersPublic', { limit: 200 })
        .then((items) => items.find((t) => t._id === teacherId));
      fillTeacherForm(teacher || null);
      loadCourses(teacherId);
      fillCourseForm(null);
    });

    createTeacherBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex) return;
      teacherNotice.textContent = '';
      try {
        await convex.mutation('teachers:create', {
          name: teacherNameInput.value.trim(),
          subject: teacherSubjectInput.value.trim(),
          bio: teacherBioInput.value.trim(),
          gender: teacherGenderInput.value.trim(),
          imageUrl: currentTeacherImage || undefined
        });
        teacherNotice.textContent = 'تم إنشاء ملف المدرس.';
        await loadTeachers();
      } catch (error) {
        teacherNotice.textContent = 'تعذر إنشاء الملف.';
      }
    });

    saveTeacherBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentTeacher) return;
      teacherNotice.textContent = '';
      try {
        await convex.mutation('teachers:update', {
          id: currentTeacher._id,
          name: teacherNameInput.value.trim(),
          subject: teacherSubjectInput.value.trim(),
          bio: teacherBioInput.value.trim(),
          gender: teacherGenderInput.value.trim(),
          imageUrl: currentTeacherImage || undefined
        });
        teacherNotice.textContent = 'تم حفظ التغييرات.';
        await loadTeachers();
      } catch (error) {
        teacherNotice.textContent = 'تعذر حفظ التغييرات.';
      }
    });

    deleteTeacherBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentTeacher) return;
      teacherNotice.textContent = '';
      try {
        await convex.mutation('teachers:remove', { id: currentTeacher._id });
        teacherNotice.textContent = 'تم حذف المدرس.';
        currentTeacher = null;
        fillTeacherForm(null);
        await loadTeachers();
      } catch (error) {
        teacherNotice.textContent = 'تعذر حذف المدرس.';
      }
    });

    newCourseBtn.addEventListener('click', () => {
      fillCourseForm(null);
    });

    coursesList.addEventListener('click', async (event) => {
      const btn = event.target.closest('.edit-course-btn');
      if (!btn) return;
      const courseId = btn.getAttribute('data-course-id');
      if (!courseId || !currentTeacher) return;
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex) return;
      const courses = await convex.query('content:getCoursesPublic', { teacherId: currentTeacher._id });
      const course = courses.find((c) => c._id === courseId);
      fillCourseForm(course || null);
    });

    saveCourseBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentTeacher) return;
      courseNotice.textContent = '';
      const payload = {
        teacherId: currentTeacher._id,
        title: courseTitle.value.trim(),
        subtitle: courseSubtitle.value.trim(),
        description: courseDescription.value.trim(),
        category: courseCategory.value.trim(),
        type: courseType.value.trim(),
        status: courseStatus.value.trim(),
        grade: courseGrade.value.trim(),
        price: Number(coursePrice.value || 0),
        imageUrl: courseImageUrl.value.trim()
      };
      try {
        if (currentCourseId) {
          await convex.mutation('courses:update', { id: currentCourseId, ...payload });
        } else {
          await convex.mutation('courses:create', payload);
        }
        courseNotice.textContent = 'تم حفظ الدورة.';
        fillCourseForm(null);
        await loadCourses(currentTeacher._id);
      } catch (error) {
        courseNotice.textContent = 'تعذر حفظ الدورة.';
      }
    });

    deleteCourseBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentCourseId) return;
      courseNotice.textContent = '';
      try {
        await convex.mutation('courses:remove', { id: currentCourseId });
        courseNotice.textContent = 'تم حذف الدورة.';
        fillCourseForm(null);
        await loadCourses(currentTeacher._id);
      } catch (error) {
        courseNotice.textContent = 'تعذر حذف الدورة.';
      }
    });

    loadTeachers();



  </script>



</body>



</html>



