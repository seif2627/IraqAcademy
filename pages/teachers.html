<!DOCTYPE html>



<html lang="en">
<head>



  <meta charset="UTF-8">



  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teachers | Iraq Academy</title>
  <meta name="description" content="Meet Iraq Academy teachers and browse their courses.">
  <link rel="icon" href="../Logo/LogoNoBackground.png" type="image/png">



  <script src="https://cdn.tailwindcss.com"></script>



  <link rel="stylesheet" href="../assets/styles.css">



</head>



<body class="bg-slate-50 text-slate-800">



  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-16">
      <h1 class="text-4xl font-extrabold text-slate-900 mb-4">Our Teaching Staff</h1>
      <p class="text-xl text-slate-600 max-w-3xl mx-auto">A distinguished group of teachers offering the best learning experience.</p>
    </div>

    <section id="teacherManagement" class="hidden bg-white border border-slate-200 rounded-2xl p-6 shadow-sm mb-12">
      <div class="flex items-start justify-between flex-wrap gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-bold mb-2">Teacher & Course Management</h2>
          <p class="text-slate-600">Manage teacher profile and courses based on permissions.</p>
        </div>
        <div id="teacherManageRole" class="text-sm text-emerald-700 bg-emerald-50 px-3 py-2 rounded-xl"></div>
      </div>
      <div class="grid lg:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div id="teacherSelectWrap" class="hidden">
            <label class="block text-sm font-medium text-slate-700 mb-1">Select Teacher</label>
            <select id="teacherSelect" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none"></select>
          </div>
          <input id="teacherNameInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Teacher Name">
          <input id="teacherSubjectInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Subject">
          <textarea id="teacherBioInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" rows="4" placeholder="Short Bio"></textarea>
          <input id="teacherGenderInput" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Gender">
          <div class="flex gap-3">
            <button id="saveTeacherBtn" class="flex-1 bg-accent text-white rounded-xl py-3 font-bold shadow-lg hover:bg-emerald-600 transition-all">Save Teacher</button>
            <button id="createTeacherBtn" class="flex-1 border border-slate-200 rounded-xl py-3 font-bold text-slate-700 hover:border-accent hover:text-accent transition-all hidden">Create Profile</button>
          </div>
          <button id="deleteTeacherBtn" class="w-full border border-rose-200 text-rose-600 rounded-xl py-3 font-bold hover:bg-rose-50 transition-all hidden">Delete Teacher</button>
          <div id="teacherNotice" class="text-sm text-slate-600"></div>
        </div>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold">Courses</h3>
            <button id="newCourseBtn" class="px-4 py-2 rounded-xl border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors">Add Course</button>
          </div>
          <div class="grid gap-3" id="coursesList"></div>
          <div class="border border-slate-200 rounded-2xl p-4">
            <h4 class="text-sm font-bold text-slate-700 mb-2">Enrollments for Selected Course</h4>
            <div id="enrollmentsList" class="space-y-2 text-sm text-slate-600">Select a course to view enrollments.</div>
          </div>
          <div class="border border-slate-200 rounded-2xl p-4 space-y-3">
            <input id="courseTitle" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Course Title">
            <input id="courseSubtitle" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Short Summary">
            <textarea id="courseDescription" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" rows="3" placeholder="Course Description"></textarea>
            <div class="grid md:grid-cols-2 gap-3">
              <input id="courseCategory" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Category">
              <input id="courseType" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Type">
              <input id="courseStatus" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Status">
              <input id="courseGrade" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Grade">
              <input id="coursePrice" type="number" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Price">
              <input id="courseImageUrl" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Course Image URL">
            </div>
            <div class="flex gap-3">
              <button id="saveCourseBtn" class="flex-1 bg-accent text-white rounded-xl py-3 font-bold shadow-lg hover:bg-emerald-600 transition-all">Save Course</button>
              <button id="deleteCourseBtn" class="flex-1 border border-rose-200 text-rose-600 rounded-xl py-3 font-bold hover:bg-rose-50 transition-all hidden">Delete Course</button>
            </div>
            <div id="courseNotice" class="text-sm text-slate-600"></div>
          </div>
        </div>
      </div>
    </section>






    <div id="teachers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="display: none;"></div>



    



    <div id="loading" class="text-center py-12">



      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-slate-200 border-t-accent"></div>



      <p class="mt-4 text-slate-500">Loading teachers...</p>
    </div>



  </main>







  <script src="../assets/config.js"></script>
  <script type="module" src="../assets/firebase.js"></script>



  <script type="module" src="../assets/convex.js"></script>
  <script src="../assets/auth.js"></script>



  <script>



    const grid = document.getElementById('teachers-grid');



    const loading = document.getElementById('loading');
    const management = document.getElementById('teacherManagement');
    const manageRole = document.getElementById('teacherManageRole');
    const teacherSelectWrap = document.getElementById('teacherSelectWrap');
    const teacherSelect = document.getElementById('teacherSelect');
    const teacherNameInput = document.getElementById('teacherNameInput');
    const teacherSubjectInput = document.getElementById('teacherSubjectInput');
    const teacherBioInput = document.getElementById('teacherBioInput');
    const teacherGenderInput = document.getElementById('teacherGenderInput');
    const saveTeacherBtn = document.getElementById('saveTeacherBtn');
    const createTeacherBtn = document.getElementById('createTeacherBtn');
    const deleteTeacherBtn = document.getElementById('deleteTeacherBtn');
    const teacherNotice = document.getElementById('teacherNotice');
    const coursesList = document.getElementById('coursesList');
    const newCourseBtn = document.getElementById('newCourseBtn');
    const courseTitle = document.getElementById('courseTitle');
    const courseSubtitle = document.getElementById('courseSubtitle');
    const courseDescription = document.getElementById('courseDescription');
    const courseCategory = document.getElementById('courseCategory');
    const courseType = document.getElementById('courseType');
    const courseStatus = document.getElementById('courseStatus');
    const courseGrade = document.getElementById('courseGrade');
    const coursePrice = document.getElementById('coursePrice');
    const courseImageUrl = document.getElementById('courseImageUrl');
    const saveCourseBtn = document.getElementById('saveCourseBtn');
    const deleteCourseBtn = document.getElementById('deleteCourseBtn');
    const courseNotice = document.getElementById('courseNotice');
    const enrollmentsList = document.getElementById('enrollmentsList');

    let currentTeacher = null;
    let currentCourseId = null;
    let currentRole = 'student';
    let isCreatingTeacher = false;
    let isSavingTeacher = false;
    let isDeletingTeacher = false;
    let isSavingCourse = false;
    let isDeletingCourse = false;

    const waitForConvex = (timeoutMs = 5000) => new Promise((resolve, reject) => {
      const start = Date.now();
      const timer = setInterval(() => {
        const client = window.top?.convexClient || window.convexClient;
        if (client) {
          clearInterval(timer);
          resolve(client);
          return;
        }
        if (Date.now() - start >= timeoutMs) {
          clearInterval(timer);
          reject(new Error('Convex client not ready'));
        }
      }, 50);
    });

    const waitForAuthReady = (timeoutMs = 5000) => {
      const authReady = window.top?.iaAuthReady || window.iaAuthReady;
      if (!authReady || typeof authReady.then !== 'function') {
        return Promise.resolve();
      }
      return new Promise((resolve) => {
        let settled = false;
        const timer = setTimeout(() => {
          if (settled) return;
          settled = true;
          resolve();
        }, timeoutMs);
        authReady.then(() => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          resolve();
        }).catch(() => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          resolve();
        });
      });
    };

    const getConvexClient = async () => {
      const existing = window.top?.convexClient || window.convexClient;
      if (existing) {
        await waitForAuthReady();
        return existing;
      }
      try {
        const client = await waitForConvex();
        await waitForAuthReady();
        return client;
      } catch (error) {
        return null;
      }
    };

    const getSearchTerm = () => {
      const params = new URLSearchParams(window.location.search);
      return (params.get('search') || '').trim();
    };

    const withTimeout = async (promise, timeoutMs = 8000) => {
      let timeoutId;
      const timeoutPromise = new Promise((_, reject) => {
        timeoutId = setTimeout(() => reject(new Error('Request timed out')), timeoutMs);
      });
      try {
        return await Promise.race([promise, timeoutPromise]);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    const registerButtonLabel = (button) => {
      if (!button || button.dataset.label) return;
      button.dataset.label = button.textContent;
    };

    const setButtonBusy = (button, busy, busyLabel) => {
      if (!button) return;
      registerButtonLabel(button);
      button.disabled = busy;
      button.setAttribute('aria-busy', busy ? 'true' : 'false');
      button.textContent = busy ? busyLabel : button.dataset.label;
    };

    const avatarSvgs = {
      male: `
        <svg class="w-16 h-16" viewBox="0 0 80 80" aria-hidden="true">
          <circle cx="40" cy="30" r="16" fill="#f5d0b5"></circle>
          <path d="M22 30c4-12 32-12 36 0v6H22z" fill="#1f2937"></path>
          <path d="M16 72c4-18 18-26 24-26s20 8 24 26" fill="#e2e8f0"></path>
        </svg>
      `,
      female: `
        <svg class="w-16 h-16" viewBox="0 0 80 80" aria-hidden="true">
          <circle cx="40" cy="32" r="15" fill="#f5d0b5"></circle>
          <path d="M18 36c2-18 14-26 22-26s20 8 22 26v12H18z" fill="#312e81"></path>
          <path d="M14 72c4-18 18-26 26-26s22 8 26 26" fill="#fde68a"></path>
        </svg>
      `,
      neutral: `
        <svg class="w-16 h-16" viewBox="0 0 80 80" aria-hidden="true">
          <circle cx="40" cy="30" r="16" fill="#fde4cf"></circle>
          <path d="M18 72c4-18 18-26 22-26s18 8 22 26" fill="#e5e7eb"></path>
          <circle cx="30" cy="28" r="3" fill="#0f172a"></circle>
          <circle cx="50" cy="28" r="3" fill="#0f172a"></circle>
        </svg>
      `
    };

    const getTeacherAvatarSvg = (genderValue) => {
      const normalized = String(genderValue || '').trim().toLowerCase();
      if (['female', 'f', 'woman', 'girl'].includes(normalized)) return avatarSvgs.female;
      if (['male', 'm', 'man', 'boy'].includes(normalized)) return avatarSvgs.male;
      return avatarSvgs.neutral;
    };







    const fillTeacherForm = (teacher) => {
      currentTeacher = teacher;
      teacherNameInput.value = teacher?.name || '';
      teacherSubjectInput.value = teacher?.subject || '';
      teacherBioInput.value = teacher?.bio || '';
      teacherGenderInput.value = teacher?.gender || '';
      deleteTeacherBtn.classList.toggle('hidden', !teacher || !(currentRole === 'admin' || currentRole === 'owner'));
    };

    const fillCourseForm = (course) => {
      currentCourseId = course?._id || null;
      courseTitle.value = course?.title || '';
      courseSubtitle.value = course?.subtitle || '';
      courseDescription.value = course?.description || '';
      courseCategory.value = course?.category || '';
      courseType.value = course?.type || '';
      courseStatus.value = course?.status || '';
      courseGrade.value = course?.grade || '';
      coursePrice.value = course?.price || '';
      courseImageUrl.value = course?.imageUrl || '';
      deleteCourseBtn.classList.toggle('hidden', !course);
    };

    const renderCourses = (courses) => {
      coursesList.innerHTML = '';
      if (!courses.length) {
        coursesList.innerHTML = '<div class="text-sm text-slate-500">No courses yet.</div>';
        return;
      }
      courses.forEach((course) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'border border-slate-100 rounded-xl p-3 flex items-center justify-between gap-3 flex-wrap';
        wrapper.innerHTML = `
          <div>
            <div class="course-title font-bold text-slate-900"></div>
            <div class="course-status text-xs text-slate-500"></div>
          </div>
          <button class="edit-course-btn px-3 py-1 rounded-lg border border-slate-200 text-sm hover:border-accent hover:text-accent transition-colors" data-course-id="${course._id}">Edit</button>
        `;
        const titleEl = wrapper.querySelector('.course-title');
        const statusEl = wrapper.querySelector('.course-status');
        if (titleEl) titleEl.textContent = course.title || 'Course';
        if (statusEl) statusEl.textContent = course.status || 'Available';
        coursesList.appendChild(wrapper);
      });
    };

    const loadCourses = async (teacherId) => {
      const convex = await getConvexClient();
      if (!convex || !teacherId) {
        if (teacherId) {
          coursesList.innerHTML = '<div class="text-sm text-slate-500">We could not load courses right now.</div>';
        }
        return;
      }
      try {
        const courses = await withTimeout(convex.query('content:getCoursesPublic', { teacherId }));
        renderCourses(courses);
        enrollmentsList.textContent = 'Select a course to view enrollments.';
      } catch (error) {
        coursesList.innerHTML = '<div class="text-sm text-slate-500">We could not load courses right now.</div>';
      }
    };

    const loadEnrollmentsForCourse = async (courseId) => {
      const convex = await getConvexClient();
      if (!convex || !courseId) {
        enrollmentsList.textContent = 'Select a course to view enrollments.';
        return;
      }
      try {
        const enrollments = await withTimeout(convex.query('enrollments:listByCourse', { courseId }));
        if (!enrollments.length) {
        enrollmentsList.textContent = 'No enrollments yet.';
          return;
        }
        enrollmentsList.innerHTML = '';
        enrollments.forEach((enrollment) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between border border-slate-100 rounded-xl px-3 py-2';
          const userSpan = document.createElement('span');
          userSpan.className = 'text-slate-900';
          userSpan.textContent = enrollment.userId;
          const statusSpan = document.createElement('span');
          statusSpan.className = 'text-xs text-slate-500';
          statusSpan.textContent = enrollment.status || 'active';
          row.appendChild(userSpan);
          row.appendChild(statusSpan);
          enrollmentsList.appendChild(row);
        });
      } catch (error) {
        enrollmentsList.textContent = 'Unable to load enrollments. Please try again.';
      }
    };

    async function loadTeachers() {
      if (loading) {
        loading.style.display = 'block';
        const message = loading.querySelector('p');
        if (message) message.textContent = 'Loading teachers...';
      }

      const convex = await getConvexClient();
      const client = window.top?.authClient || window.authClient;

      if (!convex) {
        if (grid) {
          grid.style.display = 'block';
          grid.innerHTML = '<div class="text-slate-500 text-sm">We are having trouble loading teachers right now. Please try again.</div>';
        }
        if (loading) loading.style.display = 'none';
        return;
      }

      try {
        const searchTerm = getSearchTerm();
        const teachers = await withTimeout(convex.query('content:getTeachersPublic', {
          limit: 200,
          search: searchTerm || undefined
        }));
        if (client) {
          const { data: { session } } = await client.auth.getSession();
          currentRole = session?.user?.user_metadata?.role || 'student';
          if (session && (currentRole === 'teacher' || currentRole === 'admin' || currentRole === 'owner')) {
            management.classList.remove('hidden');
            manageRole.textContent = currentRole === 'teacher' ? 'Teacher permissions' : 'Admin permissions';
          } else {
            management.classList.add('hidden');
          }
        }

        grid.innerHTML = '';
        if (!teachers.length) {
          const empty = document.createElement('div');
          empty.className = 'text-slate-500 text-sm';
          empty.textContent = searchTerm
            ? `No teachers match "${searchTerm}".`
            : 'No teachers available yet.';
          grid.appendChild(empty);
          grid.style.display = 'block';
        }

        teachers.forEach((teacher) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'teacher-card bg-white border border-slate-100 rounded-2xl p-6 text-center shadow-sm hover:shadow-xl transition-all duration-300';
          const avatarSvg = getTeacherAvatarSvg(teacher.gender);
          const bio = teacher.bio || '';
          const name = teacher.name || 'Teacher';
          const subject = teacher.subject || 'Subject';
          wrapper.innerHTML = `
            <div class="relative w-32 h-32 mx-auto mb-6">
              <div class="w-full h-full rounded-full border-4 border-slate-50 bg-white flex items-center justify-center">
                ${avatarSvg}
              </div>
              <div class="absolute bottom-0 right-0 w-8 h-8 bg-accent rounded-full flex items-center justify-center text-white border-4 border-white">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
              </div>
            </div>
            <h3 class="teacher-name text-xl font-bold mb-1"></h3>
            <p class="teacher-subject text-accent font-medium text-sm mb-4"></p>
            <p class="teacher-bio text-slate-500 text-sm mb-0 line-clamp-2"></p>
          `;
          const nameEl = wrapper.querySelector('.teacher-name');
          const subjectEl = wrapper.querySelector('.teacher-subject');
          const bioEl = wrapper.querySelector('.teacher-bio');
          if (nameEl) nameEl.textContent = name;
          if (subjectEl) subjectEl.textContent = subject;
          if (bioEl) bioEl.textContent = bio;
          grid.appendChild(wrapper);
        });

        grid.style.display = teachers.length ? 'grid' : 'block';
        if (loading) loading.style.display = 'none';

        if (management && !management.classList.contains('hidden')) {
          if (currentRole === 'teacher') {
            teacherSelectWrap.classList.add('hidden');
            const own = await convex.query('teachers:getOwn', {});
            if (!own) {
              fillTeacherForm(null);
              createTeacherBtn.classList.remove('hidden');
              saveTeacherBtn.classList.add('hidden');
              deleteTeacherBtn.classList.add('hidden');
              coursesList.innerHTML = '<div class="text-sm text-slate-500">No courses yet.</div>';
            } else {
              fillTeacherForm(own);
              createTeacherBtn.classList.add('hidden');
              saveTeacherBtn.classList.remove('hidden');
              loadCourses(own._id);
            }
          } else if (currentRole === 'admin' || currentRole === 'owner') {
            teacherSelectWrap.classList.remove('hidden');
            teacherSelect.innerHTML = '';
            teachers.forEach((teacher) => {
              const option = document.createElement('option');
              option.value = teacher._id;
              option.textContent = teacher.name || 'Teacher';
              teacherSelect.appendChild(option);
            });
            const selected = teachers[0] || null;
            if (selected) {
              teacherSelect.value = selected._id;
              fillTeacherForm(selected);
              loadCourses(selected._id);
              createTeacherBtn.classList.add('hidden');
              saveTeacherBtn.classList.remove('hidden');
            } else {
              fillTeacherForm(null);
              coursesList.innerHTML = '<div class="text-sm text-slate-500">No courses yet.</div>';
            }
          }
        }
      } catch (error) {
        try {
          const fallbackTeachers = await withTimeout(convex.query('content:getTeachers', {}));
          const teachers = Array.isArray(fallbackTeachers) ? fallbackTeachers : [];
          grid.innerHTML = '';
          if (!teachers.length) {
            const empty = document.createElement('div');
            empty.className = 'text-slate-500 text-sm';
            empty.textContent = getSearchTerm()
              ? `No teachers match "${getSearchTerm()}".`
              : 'No teachers available yet.';
            grid.appendChild(empty);
            grid.style.display = 'block';
          } else {
            teachers.forEach((teacher) => {
              const wrapper = document.createElement('div');
              wrapper.className = 'teacher-card bg-white border border-slate-100 rounded-2xl p-6 text-center shadow-sm hover:shadow-xl transition-all duration-300';
              const avatarSvg = getTeacherAvatarSvg(teacher.gender);
              const bio = teacher.bio || '';
              const name = teacher.name || 'Teacher';
              const subject = teacher.subject || 'Subject';
              wrapper.innerHTML = `
                <div class="relative w-32 h-32 mx-auto mb-6">
                  <div class="w-full h-full rounded-full border-4 border-slate-50 bg-white flex items-center justify-center">
                    ${avatarSvg}
                  </div>
                  <div class="absolute bottom-0 right-0 w-8 h-8 bg-accent rounded-full flex items-center justify-center text-white border-4 border-white">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                  </div>
                </div>
                <h3 class="teacher-name text-xl font-bold mb-1"></h3>
                <p class="teacher-subject text-accent font-medium text-sm mb-4"></p>
                <p class="teacher-bio text-slate-500 text-sm mb-0 line-clamp-2"></p>
              `;
              const nameEl = wrapper.querySelector('.teacher-name');
              const subjectEl = wrapper.querySelector('.teacher-subject');
              const bioEl = wrapper.querySelector('.teacher-bio');
              if (nameEl) nameEl.textContent = name;
              if (subjectEl) subjectEl.textContent = subject;
              if (bioEl) bioEl.textContent = bio;
              grid.appendChild(wrapper);
            });
            grid.style.display = 'grid';
          }
        } catch (fallbackError) {
          if (grid) {
            grid.style.display = 'block';
            grid.innerHTML = '<div class="text-slate-500 text-sm">We are having trouble loading teachers. Please try again shortly.</div>';
          }
        } finally {
          if (loading) loading.style.display = 'none';
        }
      }
    }

    teacherSelect.addEventListener('change', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      const teacherId = teacherSelect.value;
      if (!convex || !teacherId) return;
      const teacher = await convex.query('content:getTeachersPublic', { limit: 200 })
        .then((items) => items.find((t) => t._id === teacherId));
      fillTeacherForm(teacher || null);
      loadCourses(teacherId);
      loadEnrollmentsForCourse(null);
      fillCourseForm(null);
    });

    createTeacherBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex) return;
      if (isCreatingTeacher) return;
      const confirmed = confirm('Create this teacher profile?');
      if (!confirmed) return;
      teacherNotice.textContent = '';
      isCreatingTeacher = true;
      setButtonBusy(createTeacherBtn, true, 'Creating...');
      try {
        await convex.mutation('teachers:create', {
          name: teacherNameInput.value.trim(),
          subject: teacherSubjectInput.value.trim(),
          bio: teacherBioInput.value.trim(),
          gender: teacherGenderInput.value.trim()
        });
        teacherNotice.textContent = 'Teacher profile created.';
        await loadTeachers();
      } catch (error) {
        teacherNotice.textContent = 'Unable to create profile.';
      } finally {
        isCreatingTeacher = false;
        setButtonBusy(createTeacherBtn, false, 'Creating...');
      }
    });

    saveTeacherBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentTeacher) return;
      if (isSavingTeacher) return;
      const confirmed = confirm('Save changes to this teacher profile?');
      if (!confirmed) return;
      teacherNotice.textContent = '';
      isSavingTeacher = true;
      setButtonBusy(saveTeacherBtn, true, 'Saving...');
      try {
        await convex.mutation('teachers:update', {
          id: currentTeacher._id,
          name: teacherNameInput.value.trim(),
          subject: teacherSubjectInput.value.trim(),
          bio: teacherBioInput.value.trim(),
          gender: teacherGenderInput.value.trim()
        });
        teacherNotice.textContent = 'Changes saved.';
        await loadTeachers();
      } catch (error) {
        teacherNotice.textContent = 'Unable to save changes.';
      } finally {
        isSavingTeacher = false;
        setButtonBusy(saveTeacherBtn, false, 'Saving...');
      }
    });

    deleteTeacherBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentTeacher) return;
      if (isDeletingTeacher) return;
      const confirmed = confirm('Delete this teacher profile? This will remove all related courses.');
      if (!confirmed) return;
      teacherNotice.textContent = '';
      isDeletingTeacher = true;
      setButtonBusy(deleteTeacherBtn, true, 'Deleting...');
      try {
        await convex.mutation('teachers:remove', { id: currentTeacher._id });
        teacherNotice.textContent = 'Teacher deleted.';
        currentTeacher = null;
        fillTeacherForm(null);
        await loadTeachers();
      } catch (error) {
        teacherNotice.textContent = 'Unable to delete teacher.';
      } finally {
        isDeletingTeacher = false;
        setButtonBusy(deleteTeacherBtn, false, 'Deleting...');
      }
    });

    newCourseBtn.addEventListener('click', () => {
      fillCourseForm(null);
    });

    coursesList.addEventListener('click', async (event) => {
      const btn = event.target.closest('.edit-course-btn');
      if (!btn) return;
      const courseId = btn.getAttribute('data-course-id');
      if (!courseId || !currentTeacher) return;
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex) return;
      const courses = await convex.query('content:getCoursesPublic', { teacherId: currentTeacher._id });
      const course = courses.find((c) => c._id === courseId);
      fillCourseForm(course || null);
      await loadEnrollmentsForCourse(courseId);
    });

    saveCourseBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentTeacher) return;
      if (isSavingCourse) return;
      const confirmed = confirm(currentCourseId ? 'Save changes to this course?' : 'Create this course?');
      if (!confirmed) return;
      courseNotice.textContent = '';
      isSavingCourse = true;
      setButtonBusy(saveCourseBtn, true, 'Saving...');
      const payload = {
        teacherId: currentTeacher._id,
        title: courseTitle.value.trim(),
        subtitle: courseSubtitle.value.trim(),
        description: courseDescription.value.trim(),
        category: courseCategory.value.trim(),
        type: courseType.value.trim(),
        status: courseStatus.value.trim(),
        grade: courseGrade.value.trim(),
        price: Number(coursePrice.value || 0),
        imageUrl: courseImageUrl.value.trim()
      };
      try {
        if (currentCourseId) {
          await convex.mutation('courses:update', { id: currentCourseId, ...payload });
        } else {
          await convex.mutation('courses:create', payload);
        }
        courseNotice.textContent = 'Course saved.';
        fillCourseForm(null);
        await loadCourses(currentTeacher._id);
      } catch (error) {
        courseNotice.textContent = 'Unable to save course.';
      } finally {
        isSavingCourse = false;
        setButtonBusy(saveCourseBtn, false, 'Saving...');
      }
    });

    deleteCourseBtn.addEventListener('click', async () => {
      const convex = window.top?.convexClient || window.convexClient;
      if (!convex || !currentCourseId) return;
      if (isDeletingCourse) return;
      const confirmed = confirm('Delete this course? This action cannot be undone.');
      if (!confirmed) return;
      courseNotice.textContent = '';
      isDeletingCourse = true;
      setButtonBusy(deleteCourseBtn, true, 'Deleting...');
      try {
        await convex.mutation('courses:remove', { id: currentCourseId });
        courseNotice.textContent = 'Course deleted.';
        fillCourseForm(null);
        await loadCourses(currentTeacher._id);
        loadEnrollmentsForCourse(null);
      } catch (error) {
        courseNotice.textContent = 'Unable to delete course.';
      } finally {
        isDeletingCourse = false;
        setButtonBusy(deleteCourseBtn, false, 'Deleting...');
      }
    });

    loadTeachers();



  </script>



</body>



</html>
