<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>About Iraq Academy</title>
  <meta name="description" content="Learn about Iraq Academy, its mission, and its learning experience.">
  <link rel="icon" href="../Logo/LogoNoBackground.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/styles.css">
  <style>
    :root {
      --ia-accent: #10b981;
      --ia-accent-hover: #059669;
    }
    html, body {
      overflow-x: hidden;
      width: 100%;
    }
    .text-accent { color: var(--ia-accent); }
    .bg-accent { background-color: var(--ia-accent); }
    .bg-accent-hover:hover { background-color: var(--ia-accent-hover); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen p-8" dir="ltr">
  <div class="max-w-4xl mx-auto">
    <div class="mb-10 text-center">
      <h1 class="text-3xl font-bold mb-2">Account Information</h1>
      <p class="text-slate-600">Please complete your legal information before continuing to use the platform.</p>
    </div>

    <form id="infoForm" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-8">
      <div class="pb-6 border-b border-slate-100">
        <h2 class="text-lg font-bold mb-2">Account</h2>
        <p class="text-sm text-slate-500 mb-4">Your login email is tied to your account.</p>
        <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
        <input id="email" type="email" class="w-full border border-slate-200 rounded-xl px-4 py-3 bg-slate-50" readonly>
      </div>

      <div class="pb-6 border-b border-slate-100">
        <h2 class="text-lg font-bold mb-2">Profile</h2>
        <p class="text-sm text-slate-500 mb-4">These legal details are required before you can proceed.</p>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">First Name</label>
            <input id="firstName" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="First Name">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Middle Name</label>
            <input id="middleName" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Middle Name">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Last Name</label>
            <input id="lastName" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Last Name">
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-slate-700 mb-1">Phone Number</label>
          <input id="phone" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Phone Number">
        </div>
      </div>

      <div class="pb-6 border-b border-slate-100">
        <h2 class="text-lg font-bold mb-2">Address</h2>
        <p class="text-sm text-slate-500 mb-4">Use your current residential address.</p>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Full Address</label>
          <input id="address" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Full Address">
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">City / Area</label>
            <input id="city" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="City or Area">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Governorate</label>
            <input id="governorate" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Governorate">
          </div>
        </div>
      </div>

      <div class="pb-6 border-b border-slate-100">
        <h2 class="text-lg font-bold mb-2">Security</h2>
        <p class="text-sm text-slate-500 mb-4">Verify your email to activate your account.</p>
        <div id="verifyBanner" class="hidden border border-amber-200 bg-amber-50 text-amber-700 px-4 py-3 rounded-xl">
          Please verify your email address first. A verification email has been sent to your inbox.
          <button id="resendVerification" class="mr-2 text-amber-800 font-bold hover:underline">Resend</button>
        </div>
      </div>

      <div>
        <h2 class="text-lg font-bold mb-2">Identity (Optional)</h2>
        <p class="text-sm text-slate-500 mb-4">Optional details to keep your profile complete.</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">National ID Number</label>
            <input id="idNumber" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="ID Number">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Date of Birth</label>
            <input id="birthDate" type="date" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none">
          </div>
        </div>
      </div>

      <button id="saveBtn" class="w-full bg-accent text-white rounded-xl py-3 font-bold shadow-lg hover:bg-emerald-600 transition-all">Save Information</button>
      <button id="cancelOnboarding" type="button" class="w-full border border-rose-200 text-rose-600 rounded-xl py-3 font-semibold hover:bg-rose-50 transition-all">Cancel setup and delete account</button>
    </form>
  </div>
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <script src="../assets/config.js"></script>
  <script type="module" src="../assets/convex.js"></script>
  <script type="module" src="../assets/firebase.js"></script>
  <script src="../assets/auth.js"></script>
  <script src="../assets/store.js"></script>
  <script>
    const store = window.top?.iaStore || window.iaStore;
    const convex = window.top?.convexClient || window.convexClient;
    const client = window.top?.authClient || window.authClient;
    const form = document.getElementById('infoForm');
    const saveBtn = document.getElementById('saveBtn');
    const verifyBanner = document.getElementById('verifyBanner');
    const resendBtn = document.getElementById('resendVerification');
    const cancelBtn = document.getElementById('cancelOnboarding');

    const fields = {
      email: document.getElementById('email'),
      firstName: document.getElementById('firstName'),
      middleName: document.getElementById('middleName'),
      lastName: document.getElementById('lastName'),
      phone: document.getElementById('phone'),
      governorate: document.getElementById('governorate'),
      city: document.getElementById('city'),
      address: document.getElementById('address'),
      idNumber: document.getElementById('idNumber'),
      birthDate: document.getElementById('birthDate')
    };

    const getFirebaseUser = () => window.firebaseAuth?.auth?.currentUser || null;

    const showToast = (message, tone = 'error') => {
      const container = document.getElementById('toastContainer');
      if (!container || !message) return;
      const toast = document.createElement('div');
      toast.className = `toast toast--${tone}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 4000);
    };

    const updateVerificationState = () => {
      const user = getFirebaseUser();
      if (user && !user.emailVerified) {
        verifyBanner.classList.remove('hidden');
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        verifyBanner.classList.add('hidden');
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    };

    resendBtn.addEventListener('click', async () => {
      const user = getFirebaseUser();
      if (user) {
        await window.firebaseAuth.sendEmailVerification(user);
        showToast('Verification email sent again.', 'success');
      }
    });

    const resolveRole = async (session) => {
      let role = session?.user?.user_metadata?.role || 'student';
      if (!convex || !session?.user?.id) return role;
      try {
        const user = await convex.query('users:getByUserId', { userId: session.user.id });
        if (user?.role) role = user.role;
      } catch (error) {
        return role;
      }
      return role;
    };

    const getRoleDestination = async () => {
      const session = await client?.auth?.getSession?.();
      const activeSession = session?.data?.session || null;
      const role = await resolveRole(activeSession);
      if (role === 'teacher') return 'teachers';
      if (role === 'admin' || role === 'owner') return 'accounts';
      return 'students';
    };

    const loadProfile = async () => {
      const session = await client?.auth?.getSession?.();
      const email = session?.data?.session?.user?.email || getFirebaseUser()?.email || '';
      fields.email.value = email;
      const profile = await store.getProfile();
      if (profile) {
        const parts = String(profile.fullName || '').trim().split(/\s+/).filter(Boolean);
        fields.firstName.value = parts[0] || '';
        fields.lastName.value = parts.length > 1 ? parts[parts.length - 1] : '';
        fields.middleName.value = parts.length > 2 ? parts.slice(1, -1).join(' ') : '';
        fields.phone.value = profile.phone || '';
        fields.governorate.value = profile.governorate || '';
        fields.city.value = profile.city || '';
        fields.address.value = profile.address || '';
        fields.idNumber.value = profile.idNumber || '';
        fields.birthDate.value = profile.birthDate || '';
      }
    };

    const validateRequiredFields = () => {
      const firstName = fields.firstName.value.trim();
      const middleName = fields.middleName.value.trim();
      const lastName = fields.lastName.value.trim();
      const phone = fields.phone.value.trim();
      const address = fields.address.value.trim();
      if (!firstName || !middleName || !lastName) {
        showToast('First, middle, and last names are required.', 'error');
        return false;
      }
      if (!phone) {
        showToast('Phone number is required.', 'error');
        return false;
      }
      if (!address) {
        showToast('Full address is required.', 'error');
        return false;
      }
      return true;
    };

    let onboardingCompleted = false;

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (saveBtn.disabled) {
        showToast('Please verify your email first.', 'error');
        return;
      }
      if (!validateRequiredFields()) return;
      const fullName = `${fields.firstName.value.trim()} ${fields.middleName.value.trim()} ${fields.lastName.value.trim()}`;
      await store.saveProfile({
        fullName,
        phone: fields.phone.value.trim(),
        governorate: fields.governorate.value.trim(),
        city: fields.city.value.trim(),
        address: fields.address.value.trim(),
        idNumber: fields.idNumber.value.trim(),
        birthDate: fields.birthDate.value.trim()
      });
      onboardingCompleted = true;
      showToast('Information saved successfully.', 'success');
      if (window.parent) {
        window.parent.onboardingRequired = false;
        if (typeof window.parent.checkAuthState === 'function') {
          await window.parent.checkAuthState();
        }
      }
      const destination = await getRoleDestination();
      window.parent.navigateTo(destination);
    });

    const cleanupOnboarding = async () => {
      const session = await client?.auth?.getSession?.();
      const activeSession = session?.data?.session || null;
      if (activeSession?.user?.id && convex) {
        try {
          await convex.mutation('users:cleanupOnboarding', { userId: activeSession.user.id });
        } catch (error) {
          // best-effort cleanup
        }
      }
      if (window.firebaseAuth?.auth?.currentUser && window.firebaseAuth?.deleteUser) {
        try {
          await window.firebaseAuth.deleteUser(window.firebaseAuth.auth.currentUser);
        } catch (error) {
          // ignore delete failures
        }
      }
      if (client?.auth?.signOut) {
        await client.auth.signOut();
      }
    };

    if (cancelBtn) {
      cancelBtn.addEventListener('click', async () => {
        await cleanupOnboarding();
        showToast('Account setup canceled. Please sign up again to continue.', 'error');
        if (window.parent) {
          window.parent.onboardingRequired = false;
        }
        window.parent.navigateTo('signup');
      });
    }

    window.addEventListener('beforeunload', (event) => {
      if (onboardingCompleted) return;
      cleanupOnboarding();
    });

    if (window.firebaseAuth?.onAuthStateChanged) {
      window.firebaseAuth.onAuthStateChanged(window.firebaseAuth.auth, () => {
        updateVerificationState();
        loadProfile();
      });
    } else {
      updateVerificationState();
      loadProfile();
    }
  </script>
</body>
</html>
