<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>About Iraq Academy</title>
  <meta name="description" content="Learn about Iraq Academy, its mission, and its learning experience.">
  <link rel="icon" href="../Logo/LogoNoBackground.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --ia-accent: #10b981;
      --ia-accent-hover: #059669;
    }
    html, body {
      overflow-x: hidden;
      width: 100%;
    }
    .text-accent { color: var(--ia-accent); }
    .bg-accent { background-color: var(--ia-accent); }
    .bg-accent-hover:hover { background-color: var(--ia-accent-hover); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen p-8" dir="ltr">
  <div class="max-w-4xl mx-auto">
    <div class="mb-10 text-center">
      <h1 class="text-3xl font-bold mb-2">Account Information</h1>
      <p class="text-slate-600">Please complete your legal information before continuing to use the platform.</p>
    </div>

    <div id="verifyBanner" class="hidden mb-4 border border-amber-200 bg-amber-50 text-amber-700 px-4 py-3 rounded-xl">
      Please verify your email address first. A verification email has been sent to your inbox.
      <button id="resendVerification" class="mr-2 text-amber-800 font-bold hover:underline">Resend</button>
    </div>

    <form id="infoForm" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-5">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Email Address</label>
        <input id="email" type="email" class="w-full border border-slate-200 rounded-xl px-4 py-3 bg-slate-50" readonly>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
          <input id="fullName" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Full Name">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Phone Number</label>
          <input id="phone" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Phone Number">
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Governorate</label>
          <input id="governorate" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Governorate">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">City / Area</label>
          <input id="city" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="City or Area">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Full Address</label>
        <input id="address" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="Full Address">
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">National ID Number</label>
          <input id="idNumber" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none" placeholder="ID Number">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Date of Birth</label>
          <input id="birthDate" type="date" class="w-full border border-slate-200 rounded-xl px-4 py-3 focus:border-accent outline-none">
        </div>
      </div>
      <button id="saveBtn" class="w-full bg-accent text-white rounded-xl py-3 font-bold shadow-lg hover:bg-emerald-600 transition-all">Save Information</button>
      <div id="formNotice" class="text-sm text-center text-slate-600"></div>
    </form>
  </div>

  <script src="../assets/config.js"></script>
  <script type="module" src="../assets/convex.js"></script>
  <script type="module" src="../assets/firebase.js"></script>
  <script src="../assets/auth.js"></script>
  <script src="../assets/store.js"></script>
  <script>
    const store = window.top?.iaStore || window.iaStore;
    const form = document.getElementById('infoForm');
    const notice = document.getElementById('formNotice');
    const saveBtn = document.getElementById('saveBtn');
    const verifyBanner = document.getElementById('verifyBanner');
    const resendBtn = document.getElementById('resendVerification');

    const fields = {
      email: document.getElementById('email'),
      fullName: document.getElementById('fullName'),
      phone: document.getElementById('phone'),
      governorate: document.getElementById('governorate'),
      city: document.getElementById('city'),
      address: document.getElementById('address'),
      idNumber: document.getElementById('idNumber'),
      birthDate: document.getElementById('birthDate')
    };

    const getFirebaseUser = () => window.firebaseAuth?.auth?.currentUser || null;

    const updateVerificationState = () => {
      const user = getFirebaseUser();
      if (user && !user.emailVerified) {
        verifyBanner.classList.remove('hidden');
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        verifyBanner.classList.add('hidden');
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    };

    resendBtn.addEventListener('click', async () => {
      const user = getFirebaseUser();
      if (user) {
        await window.firebaseAuth.sendEmailVerification(user);
        notice.textContent = 'Verification email sent again.';
      }
    });

    const loadProfile = async () => {
      const session = await (window.top?.authClient || window.authClient)?.auth?.getSession?.();
      const email = session?.data?.session?.user?.email || getFirebaseUser()?.email || '';
      fields.email.value = email;
      const profile = await store.getProfile();
      if (profile) {
        fields.fullName.value = profile.fullName || '';
        fields.phone.value = profile.phone || '';
        fields.governorate.value = profile.governorate || '';
        fields.city.value = profile.city || '';
        fields.address.value = profile.address || '';
        fields.idNumber.value = profile.idNumber || '';
        fields.birthDate.value = profile.birthDate || '';
      }
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      notice.textContent = '';
      if (saveBtn.disabled) {
        notice.textContent = 'Please verify your email first.';
        return;
      }
      await store.saveProfile({
        fullName: fields.fullName.value.trim(),
        phone: fields.phone.value.trim(),
        governorate: fields.governorate.value.trim(),
        city: fields.city.value.trim(),
        address: fields.address.value.trim(),
        idNumber: fields.idNumber.value.trim(),
        birthDate: fields.birthDate.value.trim()
      });
      notice.textContent = 'Information saved successfully.';
      window.parent.navigateTo('home');
    });

    if (window.firebaseAuth?.onAuthStateChanged) {
      window.firebaseAuth.onAuthStateChanged(window.firebaseAuth.auth, () => {
        updateVerificationState();
        loadProfile();
      });
    } else {
      updateVerificationState();
      loadProfile();
    }
  </script>
</body>
</html>
